/**
 * Generate runtime configuration from app.config.yaml
 */

const fs = require('fs');
const path = require('path');

const yaml = require('js-yaml');

// Read app.config.yaml
const appConfig = yaml.load(fs.readFileSync(path.resolve(__dirname, '../app.config.yaml'), 'utf8'));

// Extract action names from config
const actions = Object.keys(
  appConfig.application.runtimeManifest.packages['kukla-integration-service'].actions
);

// Generate runtime configuration
const runtimeConfig = {
  runtime: {
    baseUrl: process.env.VITE_APP_URL || 'https://localhost',
    port: parseInt(process.env.VITE_APP_PORT || '9080', 10),
    paths: {
      base: '/api',
      web: '/v1/web',
    },
    version: 'v1',
    namespace: 'kukla-integration-service',
    package: 'kukla-integration-service',
    actions: actions.reduce((acc, action) => {
      acc[action] = action;
      return acc;
    }, {}),
  },
};

// Write backend runtime configuration
fs.writeFileSync(
  path.resolve(__dirname, '../config/generated/runtime.config.js'),
  `/**
 * GENERATED FILE - DO NOT EDIT
 * This file is automatically generated from app.config.yaml
 */

module.exports = ${JSON.stringify(runtimeConfig, null, 2)};
`
);

// Write frontend runtime configuration
fs.writeFileSync(
  path.resolve(__dirname, '../web-src/src/config/generated/runtime.config.js'),
  `/**
 * GENERATED FILE - DO NOT EDIT
 * This file is automatically generated from app.config.yaml
 */

export default ${JSON.stringify(runtimeConfig, null, 2)};
`
);
